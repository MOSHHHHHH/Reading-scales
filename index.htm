<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¨×’×•×œ ×¡×•×œ××•×ª</title>
    <!-- ×˜×¢×™× ×ª Tailwind CSS ×¢×‘×•×¨ ×¢×™×¦×•×‘ ××•×“×¨× ×™ ×•××¡×ª×˜×™×§×” -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#f97316',
                        'correct': '#10b981',
                        'incorrect': '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f3f4f6;
        }
        .answer-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
        }
        .answer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .correct-animation {
            animation: pulse-correct 0.5s ease-out;
        }
        .incorrect-animation {
            animation: shake 0.4s ease-in-out;
        }
        @keyframes pulse-correct {
            0% { transform: scale(1); background-color: #f3f4f6; }
            50% { transform: scale(1.03); background-color: #d1fae5; }
            100% { transform: scale(1); background-color: #f3f4f6; }
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
            100% { transform: translateX(0); }
        }
        /* ××¢×‘×¨ ×‘×™×Ÿ ××¡×›×™× */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ×”××¤×œ×™×§×¦×™×” ×”××¨×›×–×™×ª -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-4xl font-bold text-center text-primary mb-6">ğŸ¼ ×ª×¨×’×•×œ ×¡×•×œ××•×ª</h1>

        <!-- ×ª×¦×•×’×ª ××™××•×Ÿ (×‘×¨×™×¨×ª ××—×“×œ) -->
        <div id="practice-view" class="fade-in">
            <div id="question-header" class="text-center mb-6">
                <!-- ×˜×™×™××¨ ×•××•× ×” ×™×•×¤×™×¢×• ×›××Ÿ -->
            </div>

            <div id="key-signature" class="flex flex-col items-center justify-center mb-8 bg-gray-50 p-4 rounded-lg shadow-inner">
                <img id="scale-image" src="" alt="×—×ª×™××ª ×”××¤×ª×—" class="max-h-32 object-contain rounded-lg shadow-md mb-3 transition duration-300 transform hover:scale-105" onerror="this.onerror=null; this.src='https://placehold.co/300x120/E5E7EB/6B7280?text=×ª××•× ×ª+×¡×•×œ×';" />
                <p id="question-text" class="text-2xl font-semibold text-gray-700"></p>
                <div id="feedback-message" class="mt-2 text-xl font-bold transition duration-300"></div>
            </div>

            <div id="answers-container" class="grid grid-cols-1 gap-4">
                <!-- ×›×¨×˜×™×¡×™×•×ª ×”×ª×©×•×‘×•×ª ×™×•×¦×’×• ×›××Ÿ -->
            </div>

            <div id="status-footer" class="text-center mt-6 p-3 bg-primary/10 rounded-lg">
                <p id="timer" class="text-2xl font-mono text-primary inline-block"></p>
                <p id="score-counter" class="text-lg font-medium text-gray-600 mt-1"></p>
            </div>
        </div>

        <!-- ×ª×¦×•×’×ª ×©×™××™× (××•×¡×ª×¨×ª ×‘×”×ª×—×œ×”) -->
        <div id="highscores-view" class="fade-in hidden">
            <h2 class="text-3xl font-bold text-center text-secondary mb-6">ğŸ† ×©×™××™ ××”×™×¨×•×ª</h2>
            <ul id="highscores-list" class="space-y-3 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <!-- ×¨×©×™××ª ×”×©×™××™× ×ª×•×¤×™×¢ ×›××Ÿ -->
            </ul>
            <div id="new-record-message" class="text-center mt-4 text-2xl font-extrabold text-correct hidden">×©×™× ×—×“×©! ××“×”×™×!</div>
            <button id="restart-button" class="mt-8 w-full py-3 bg-primary text-white font-bold rounded-lg shadow-lg hover:bg-primary/90 transition duration-300 transform hover:scale-[1.01]">×—×–×•×¨ ×œ×”×ª×—×œ×”</button>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------------------
        // 1. ×”×’×“×¨×•×ª ×•× ×ª×•× ×™ ×‘×¡×™×¡
        // ---------------------------------------------------------------------

        // ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ×œ-Firebase (××•×¡×ª×¨×•×ª ××š × ×“×¨×©×•×ª ×¢×œ ×™×“×™ ×”×¡×‘×™×‘×”)
        // ×œ×¦×•×¨×š ×¢××™×“×” ×‘×“×¨×™×©×ª ×”-Local Storage, ×œ× × ×©×ª××© ×‘-Firestore ×‘×¤×•×¢×œ.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'scale-quiz-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ×”×’×“×¨×ª ××¢×¨×š ×”×¡×•×œ××•×ª ×”××œ× (15 ×¡×•×œ××•×ª, ×›×•×œ×œ ×©××¨×¤ ×•×›×¤×•×œ ×‘××•×œ)
        const SCALES = [
            // Major Scales (Sharp keys)
            { root_en: 'C', root_he: '×“×•', sharps: 0, flats: 0, major_he: '×“×• ××–\'×•×¨', major_en: 'C Major', minor_he: '×œ×” ××™× ×•×¨', minor_en: 'A Minor', img: 'Key_Signature_C_major.jpg' },
            { root_en: 'G', root_he: '×¡×•×œ', sharps: 1, major_he: '×¡×•×œ ××–\'×•×¨', major_en: 'G Major', minor_he: '××™ ××™× ×•×¨', minor_en: 'E Minor', img: 'Key_Signature_G_major.jpg' },
            { root_en: 'D', root_he: '×¨×”', sharps: 2, major_he: '×¨×” ××–\'×•×¨', major_en: 'D Major', minor_he: '×¡×™ ××™× ×•×¨', minor_en: 'B Minor', img: 'Key_Signature_D_major.jpg' },
            { root_en: 'A', root_he: '×œ×”', sharps: 3, major_he: '×œ×” ××–\'×•×¨', major_en: 'A Major', minor_he: '×¤×”# ××™× ×•×¨', minor_en: 'F# Minor', img: 'Key_Signature_A_major.jpg' },
            { root_en: 'E', root_he: '××™', sharps: 4, major_he: '××™ ××–\'×•×¨', major_en: 'E Major', minor_he: '×“×•# ××™× ×•×¨', minor_en: 'C# Minor', img: 'Key_Signature_E_major.jpg' },
            { root_en: 'B', root_he: '×¡×™', sharps: 5, major_he: '×¡×™ ××–\'×•×¨', major_en: 'B Major', minor_he: '×¡×•×œ# ××™× ×•×¨', minor_en: 'G# Minor', img: 'Key_Signature_B_major.jpg' },
            { root_en: 'F#', root_he: '×¤×”#', sharps: 6, major_he: '×¤×”# ××–\'×•×¨', major_en: 'F# Major', minor_he: '×¨×”# ××™× ×•×¨', minor_en: 'D# Minor', img: 'Key_Signature_F_sharp_major.jpg' },
            { root_en: 'C#', root_he: '×“×•#', sharps: 7, major_he: '×“×•# ××–\'×•×¨', major_en: 'C# Major', minor_he: '×œ×”# ××™× ×•×¨', minor_en: 'A# Minor', img: 'Key_Signature_of_C_sharp_major.jpg' },
            // Major Scales (Flat keys)
            { root_en: 'F', root_he: '×¤×”', flats: 1, major_he: '×¤×” ××–\'×•×¨', major_en: 'F Major', minor_he: '×¨×” ××™× ×•×¨', minor_en: 'D Minor', img: 'Key_Signature_F_major.jpg' },
            { root_en: 'Bb', root_he: '×¡×™b', flats: 2, major_he: '×¡×™ ×‘××•×œ ××–\'×•×¨', major_en: 'Bb Major', minor_he: '×¡×•×œ ××™× ×•×¨', minor_en: 'G Minor', img: 'Key_Signature_B_flat_major.jpg' },
            { root_en: 'Eb', root_he: '××™b', flats: 3, major_he: '××™ ×‘××•×œ ××–\'×•×¨', major_en: 'Eb Major', minor_he: '×“×• ××™× ×•×¨', minor_en: 'C Minor', img: 'Key_Signature_E_flat_major.jpg' },
            { root_en: 'Ab', root_he: '×œ×”b', flats: 4, major_he: '×œ×” ×‘××•×œ ××–\'×•×¨', major_en: 'Ab Major', minor_he: '×¤×” ××™× ×•×¨', minor_en: 'F Minor', img: 'Key_Signature_A_flat_major.jpg' },
            { root_en: 'Db', root_he: '×¨×”b', flats: 5, major_he: '×¨×” ×‘××•×œ ××–\'×•×¨', major_en: 'Db Major', minor_he: '×¡×™b ××™× ×•×¨', minor_en: 'Bb Minor', img: 'Key_Signature_D_flat_major.jpg' },
            { root_en: 'Gb', root_he: '×¡×•×œb', flats: 6, major_he: '×¡×•×œ ×‘××•×œ ××–\'×•×¨', major_en: 'Gb Major', minor_he: '××™b ××™× ×•×¨', minor_en: 'Eb Minor', img: 'Key_Signature_G_flat_major.jpg' },
            { root_en: 'Cb', root_he: '×“×•b', flats: 7, major_he: '×“×• ×‘××•×œ ××–\'×•×¨', major_en: 'Cb Major', minor_he: '×œ×”b ××™× ×•×¨', minor_en: 'Ab Minor', img: 'Key_Signature_C_flat_major.jpg' }
        ];

        // ××¤×¨×™×“×™× ××ª ×”×¡×•×œ××•×ª ×”××–'×•×¨ ×•×”××™× ×•×¨ ×œ×¨×©×™××•×ª × ×¤×¨×“×•×ª ×œ×‘×—×™×¨×ª ×ª×©×•×‘×•×ª
        const MAJOR_SCALES = SCALES.map(s => ({ he: s.major_he, en: s.major_en, key: s.major_en }));
        const MINOR_SCALES = SCALES.map(s => ({ he: s.minor_he, en: s.minor_en, key: s.major_en })); // key: major_en ××©××© ×œ×—×™×‘×•×¨ ×œ×—×ª×™××ª ×”××¤×ª×—

        // ××¦×‘×™ ×”××©×—×§
        let gameState = {
            currentView: 'practice', // 'practice' or 'highscores'
            currentQuestion: null,
            correctAnswersCount: 0,
            startTime: 0,
            timerInterval: null
        };

        const QUIZ_LENGTH = 10;
        const HIGH_SCORES_KEY = 'scale_quiz_high_scores';

        // ---------------------------------------------------------------------
        // 2. ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×œ×•×’×™×§×”
        // ---------------------------------------------------------------------

        /**
         * ×˜×•×¢×Ÿ ××ª ×”×©×™××™× ×”×©××•×¨×™× ×-Local Storage.
         * @returns {Array} ×¨×©×™××ª ×”×©×™××™× ×××•×™× ×ª.
         */
        function loadHighScores() {
            try {
                const scores = localStorage.getItem(HIGH_SCORES_KEY);
                return scores ? JSON.parse(scores).sort((a, b) => a.time - b.time) : [];
            } catch (error) {
                console.error("Error loading high scores from localStorage:", error);
                return [];
            }
        }

        /**
         * ×©×•××¨ ×©×™× ×—×“×© ×‘-Local Storage.
         * @param {number} time ×”×–××Ÿ ×‘××™×œ×™×©× ×™×•×ª.
         * @returns {boolean} ×”×× ×–×”×• ×©×™× ×—×“×© (× ×›× ×¡ ×œ-5 ×”××”×™×¨×™×).
         */
        function saveHighScore(time) {
            const scores = loadHighScores();
            const date = new Date().toLocaleDateString('he-IL');
            const newScore = { time, date };
            let isNewRecord = false;

            // ×”×›× ×¡×ª ×”×©×™× ×”×—×“×©
            scores.push(newScore);
            scores.sort((a, b) => a.time - b.time);

            // ×©××™×¨×ª 5 ×”×©×™××™× ×”××”×™×¨×™× ×‘×™×•×ª×¨
            const top5 = scores.slice(0, 5);

            // ×‘×“×™×§×” ×× ×”×©×™× ×”× ×•×›×—×™ × ×›× ×¡ ×œ-5 ×”××•×‘×™×œ×™×
            if (top5.some(s => s === newScore)) {
                isNewRecord = true;
            }

            try {
                localStorage.setItem(HIGH_SCORES_KEY, JSON.stringify(top5));
            } catch (error) {
                console.error("Error saving high score to localStorage:", error);
            }

            return isNewRecord;
        }

        /**
         * ×××™×¨ ××™×œ×™×©× ×™×•×ª ×œ×¤×•×¨××˜ ss:ms.
         * @param {number} ms ××™×œ×™×©× ×™×•×ª.
         * @returns {string} ×”×¤×•×¨××˜ ss:ms.
         */
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const milliseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
            const minutes = Math.floor(seconds / 60);
            const displaySeconds = (seconds % 60).toString().padStart(2, '0');
            // × ×©××¨×™× ×‘×¤×•×¨××˜ ss:ms ×›× ×“×¨×© (×“×§×•×ª ×–×” ××•×¤×¦×™×•× ×œ×™ ×× ×”×ª×¨×’×•×œ ××¨×•×š ××“×™)
            return `${displaySeconds}:${milliseconds}`;
        }

        /**
         * ××ª×—×™×œ ××ª ×˜×™×™××¨ ×”××‘×—×Ÿ.
         */
        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.startTime = Date.now();
            const timerElement = document.getElementById('timer');

            gameState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - gameState.startTime;
                timerElement.textContent = formatTime(elapsed);
            }, 10);
        }

        /**
         * ×¢×•×¦×¨ ××ª ×˜×™×™××¨ ×”××‘×—×Ÿ ×•××—×–×™×¨ ××ª ×”×–××Ÿ ×”×›×•×œ×œ.
         * @returns {number} ×”×–××Ÿ ×”×›×•×œ×œ ×‘××™×œ×™×©× ×™×•×ª.
         */
        function stopTimer() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            return Date.now() - gameState.startTime;
        }

        /**
         * ××¢×¨×‘×‘ ××¢×¨×š (××œ×’×•×¨×™×ª× Fisher-Yates).
         * @param {Array} array ×”××¢×¨×š ×œ×¢×¨×‘×•×‘.
         */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * ×‘×•×—×¨ ×¡×•×œ× ××§×¨××™ ×œ×™×¦×™×¨×ª ×©××œ×”.
         * @returns {Object} ×”××•×‘×™×™×§×˜ ×©×œ ×”×¡×•×œ× ×©× ×‘×—×¨.
         */
        function selectRandomScale() {
            const index = Math.floor(Math.random() * SCALES.length);
            return SCALES[index];
        }

        /**
         * ×‘×•× ×” ×©××œ×” ×—×“×©×” (×¡×•×œ× ×•×ª×©×•×‘×•×ª).
         */
        function generateNewQuestion() {
            // 1. ×‘×—×™×¨×ª ×¡×•×œ× ×•×¡×•×’ (××–'×•×¨/××™× ×•×¨)
            const correctScale = selectRandomScale();
            const isMajorQuestion = Math.random() < 0.5; // ××–'×•×¨ ××• ××™× ×•×¨ ×‘××•×¤×Ÿ ××§×¨××™
            const correctType = isMajorQuestion ? '××–\'×•×¨' : '××™× ×•×¨';
            const allPossibleAnswers = isMajorQuestion ? MAJOR_SCALES : MINOR_SCALES;

            // 2. ×”×’×“×¨×ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”
            const correctKey = correctScale.major_en;
            const correctAnswer = isMajorQuestion ?
                { he: correctScale.major_he, en: correctScale.major_en } :
                { he: correctScale.minor_he, en: correctScale.minor_en };

            // 3. ×‘×—×™×¨×ª 2 ××¡×™×—×™ ×“×¢×ª
            let distractors = allPossibleAnswers.filter(ans => ans.he !== correctAnswer.he);
            shuffle(distractors);
            distractors = distractors.slice(0, 2);

            // 4. ×™×¦×™×¨×ª ××¢×¨×š ×ª×©×•×‘×•×ª ×¡×•×¤×™
            const answers = [correctAnswer, ...distractors];
            shuffle(answers); // ×¢×¨×‘×•×‘ ××™×§×•× ×”×ª×©×•×‘×•×ª

            // 5. ×©××™×¨×ª ××¦×‘ ×”×©××œ×”
            gameState.currentQuestion = {
                correctKey: correctKey,
                correctAnswer: correctAnswer.he,
                correctType: correctType,
                answers: answers,
                imgFile: correctScale.img
            };

            renderQuestion();
        }

        // ---------------------------------------------------------------------
        // 3. ×¤×•× ×§×¦×™×•×ª ×¨×™× ×“×•×¨ UI
        // ---------------------------------------------------------------------

        /**
         * ××¦×™×’ ××ª ×”×©××œ×” ×”× ×•×›×—×™×ª ×¢×œ ×”××¡×š.
         */
        function renderQuestion() {
            const q = gameState.currentQuestion;
            const imgElement = document.getElementById('scale-image');
            const questionTextElement = document.getElementById('question-text');
            const answersContainer = document.getElementById('answers-container');
            const scoreCounter = document.getElementById('score-counter');
            const feedbackMessage = document.getElementById('feedback-message');

            // ××™×¤×•×¡ ×ª×¦×•×’×”
            answersContainer.innerHTML = '';
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-incorrect', 'text-correct');
            imgElement.classList.remove('incorrect-animation'); // ×”×¡×¨×ª ×× ×™××¦×™×™×ª ×˜×¢×•×ª

            // ×¢×“×›×•×Ÿ ×—×ª×™××ª ×”××¤×ª×—
            imgElement.src = `pic/${q.imgFile}`;
            questionTextElement.textContent = `××”×• ×”×¡×•×œ× ×”×–×” ×‘${q.correctType}?`;
            scoreCounter.textContent = `×ª×©×•×‘×•×ª × ×›×•× ×•×ª: ${gameState.correctAnswersCount}/${QUIZ_LENGTH}`;

            // ×¨×™× ×“×•×¨ ×”×ª×©×•×‘×•×ª
            q.answers.forEach((ans, index) => {
                const id = index + 1;
                const letter = ['×', '×‘', '×’'][index];
                const note = ['×“×•', '×¨×”', '××™'][index];

                const answerElement = document.createElement('div');
                answerElement.id = `answer-${id}`;
                answerElement.classList.add(
                    'answer-card', 'p-4', 'border', 'rounded-lg', 'shadow-md', 'text-center',
                    'bg-white', 'hover:bg-gray-100', 'flex', 'flex-col', 'items-center', 'justify-center'
                );
                answerElement.setAttribute('data-answer', ans.he);
                answerElement.setAttribute('tabindex', index + 1); // ×œ× ×’×™×©×•×ª ×•××§×œ×“×ª
                answerElement.onclick = () => checkAnswer(ans.he, answerElement);

                // ×”×˜×§×¡×˜ ×”×¢×‘×¨×™ ×œ××˜×”, ×”×œ×•×¢×–×™ ×œ××¢×œ×”, ×××•×¡×¤×¨ ×‘-ABC/×“×•-×¨×”-××™
                answerElement.innerHTML = `
                    <p class="text-sm font-light text-gray-500 mb-1">
                        ${letter} (${id}) - ${note}
                    </p>
                    <p class="text-3xl font-bold text-primary">${ans.en.replace(/#/g, 'â™¯').replace(/b/g, 'â™­')}</p>
                    <p class="text-xl font-semibold text-gray-700 mt-1">${ans.he.replace(/×“×™××–/g, '#').replace(/×‘××•×œ/g, 'b')}</p>
                `;

                answersContainer.appendChild(answerElement);
            });
        }

        /**
         * ×‘×•×“×§ ××ª ×”×ª×©×•×‘×” ×©× ×‘×—×¨×” ×¢×œ ×™×“×™ ×”××©×ª××©.
         * @param {string} selectedAnswer ×”×ª×©×•×‘×” ×©× ×‘×—×¨×” ×‘×¢×‘×¨×™×ª.
         * @param {HTMLElement} element ××œ×× ×˜ ×”×ª×©×•×‘×” ×©× ×œ×—×¥.
         */
        function checkAnswer(selectedAnswer, element) {
            const correctAnswer = gameState.currentQuestion.correctAnswer;
            const feedbackMessage = document.getElementById('feedback-message');
            const answersContainer = document.getElementById('answers-container');

            // × ×˜×¨×•×œ ×”×§×œ×§×” × ×•×¡×¤×ª
            Array.from(answersContainer.children).forEach(child => child.onclick = null);

            if (selectedAnswer === correctAnswer) {
                // ×ª×©×•×‘×” × ×›×•× ×”
                gameState.correctAnswersCount++;
                feedbackMessage.textContent = 'âœ… × ×›×•×Ÿ!';
                feedbackMessage.classList.add('text-correct');
                element.classList.add('bg-correct', 'text-white', 'correct-animation');

                document.getElementById('score-counter').textContent = `×ª×©×•×‘×•×ª × ×›×•× ×•×ª: ${gameState.correctAnswersCount}/${QUIZ_LENGTH}`;

                setTimeout(() => {
                    if (gameState.correctAnswersCount === QUIZ_LENGTH) {
                        finishQuiz();
                    } else {
                        // ××¢×‘×¨ ×œ×©××œ×” ×”×‘××”
                        renderNextQuestion();
                    }
                }, 700);

            } else {
                // ×ª×©×•×‘×” ×©×’×•×™×” - ××™×¤×•×¡
                feedbackMessage.textContent = 'âŒ ×˜×¢×•×ª, × ×¡×” ×©×•×‘';
                feedbackMessage.classList.add('text-incorrect');
                element.classList.add('bg-incorrect', 'text-white');
                document.getElementById('scale-image').classList.add('incorrect-animation');

                setTimeout(() => {
                    resetQuiz(); // ××™×¤×•×¡ ×”××‘×—×Ÿ ×›×•×œ×•
                }, 700);
            }
        }

        /**
         * ×¢×•×‘×¨ ×œ×©××œ×” ×”×‘××”.
         */
        function renderNextQuestion() {
            // ×× ×™××¦×™×” ×§×œ×” ×©×œ ×”×¡×¨×ª ×”×©××œ×” ×”×™×©× ×”
            document.getElementById('practice-view').classList.add('opacity-0');
            setTimeout(() => {
                generateNewQuestion();
                document.getElementById('practice-view').classList.remove('opacity-0');
            }, 300);
        }

        /**
         * ××¦×™×’ ××ª ×ª×¦×•×’×ª ×”×©×™××™×.
         */
        function renderHighScoresView(totalTime, isNewRecord = false) {
            stopTimer(); // ×œ×•×•×“× ×©×”×˜×™×™××¨ ×”×¤×¡×™×§
            const practiceView = document.getElementById('practice-view');
            const highscoresView = document.getElementById('highscores-view');
            const highscoresList = document.getElementById('highscores-list');
            const newRecordMessage = document.getElementById('new-record-message');

            // ×”×¡×ª×¨×ª ××™××•×Ÿ, ×”×¦×’×ª ×©×™××™×
            practiceView.classList.add('hidden');
            highscoresView.classList.remove('hidden');

            highscoresList.innerHTML = '';
            newRecordMessage.classList.add('hidden');

            const scores = loadHighScores();

            if (scores.length === 0) {
                highscoresList.innerHTML = '<li class="text-center text-gray-500">×¢×“×™×™×Ÿ ××™×Ÿ ×©×™××™× ×©××•×¨×™×. ×”×ª×—×œ ×‘××™××•×Ÿ!</li>';
            } else {
                scores.forEach((score, index) => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-3', 'rounded-lg', 'bg-white', 'shadow-sm', 'font-mono');

                    li.innerHTML = `
                        <span class="text-lg font-bold text-secondary">${index + 1}.</span>
                        <span class="text-2xl font-extrabold text-primary">${formatTime(score.time)}</span>
                        <span class="text-sm text-gray-600">${score.date}</span>
                    `;
                    highscoresList.appendChild(li);
                });
            }

            if (isNewRecord) {
                newRecordMessage.classList.remove('hidden');
            }
        }

        // ---------------------------------------------------------------------
        // 4. ×‘×§×¨×ª ××©×—×§ ×¨××©×™×ª
        // ---------------------------------------------------------------------

        /**
         * ××¤×¢×™×œ ××—×“×© ××ª ×”××‘×—×Ÿ.
         */
        function resetQuiz() {
            gameState.correctAnswersCount = 0;
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('feedback-message').textContent = '';
            document.getElementById('feedback-message').classList.remove('text-incorrect', 'text-correct');

            startTimer();
            generateNewQuestion();

            // ××¢×‘×¨ ×—×–×¨×” ×œ×ª×¦×•×’×ª ××™××•×Ÿ ×× ×”×™×™× ×• ×‘×©×™××™×
            document.getElementById('highscores-view').classList.add('hidden');
            document.getElementById('practice-view').classList.remove('hidden');
        }

        /**
         * ××¡×™×™× ××ª ×”××‘×—×Ÿ ×œ××—×¨ 10 ×ª×©×•×‘×•×ª × ×›×•× ×•×ª.
         */
        function finishQuiz() {
            const totalTime = stopTimer();
            const isNewRecord = saveHighScore(totalTime);
            renderHighScoresView(totalTime, isNewRecord);
        }

        // ---------------------------------------------------------------------
        // 5. ××ª×—×•×œ ×•×”××–× ×” ×œ××™×¨×•×¢×™×
        // ---------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // ×”××–× ×” ×œ×œ×—×™×¦×•×ª ××§×œ×“×ª (1, 2, 3)
            document.addEventListener('keydown', (e) => {
                if (gameState.currentView === 'practice' && gameState.currentQuestion) {
                    const key = e.key;
                    if (key === '1' || key === '2' || key === '3') {
                        const index = parseInt(key) - 1;
                        const answerElement = document.getElementById(`answer-${key}`);
                        if (answerElement && answerElement.onclick) {
                            // ×”×¤×¢×œ×ª ×œ×•×’×™×§×ª ×”×‘×“×™×§×” ×‘×××¦×¢×•×ª ×§×¨×™××” ×œ-onclick
                            const selectedAnswer = gameState.currentQuestion.answers[index].he;
                            checkAnswer(selectedAnswer, answerElement);
                        }
                    }
                }
            });

            // ×”××–× ×” ×œ×›×¤×ª×•×¨ "×—×–×•×¨ ×œ×”×ª×—×œ×”"
            document.getElementById('restart-button').addEventListener('click', () => {
                resetQuiz();
            });

            // ×”×ª×—×œ×ª ×”××¤×œ×™×§×¦×™×” ×‘××¦×‘ ××™××•×Ÿ
            resetQuiz();
        });

        // ×¢×“×›×•×Ÿ ××¦×‘ ×”×ª×¦×•×’×” ×‘×¢×ª ×©×™× ×•×™
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const practiceHidden = document.getElementById('practice-view').classList.contains('hidden');
                    gameState.currentView = practiceHidden ? 'highscores' : 'practice';
                }
            });
        });
        observer.observe(document.getElementById('practice-view'), { attributes: true });

    </script>
</body>
</html>
